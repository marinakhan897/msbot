name: ðŸŽ€ Marina Bot Live Monitor

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes

jobs:
  live-monitor:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ“¦ Install dependencies
      run: npm install

    - name: ðŸš€ Start Marina Bot with logging
      run: |
        echo "ðŸŽ€ STARTING MARINA KHAN AI BOT LIVE MONITOR"
        echo "==========================================="
        timeout 30s node bot.js || echo "âœ… Bot session completed"
        echo ""
        echo "ðŸ“Š MESSAGE SUMMARY:"
        echo "=================="
        
    - name: ðŸ“ˆ Show Live Message Logs
      run: |
        if [ -f "message-logs.json" ]; then
          echo "ðŸ’Œ LIVE MESSAGE ACTIVITY:"
          echo "========================="
          node -e "
          const logs = require('./message-logs.json');
          logs.forEach(log => {
            const time = new Date(log.timestamp).toLocaleTimeString();
            const emoji = log.type === 'received' ? 'ðŸ“©' : log.type === 'sent' ? 'ðŸ’Œ' : 'âš ï¸';
            const status = log.status === 'seen' ? 'ðŸ‘€ SEEN' : log.status === 'replied' ? 'ðŸ¤– REPLIED' : 'â³ ' + log.status;
            console.log(\\\`\\\${emoji} [\\\${time}] \\\${status} | \\\${log.user}: \\\"\\\${log.message}\\\"\\\`);
          });
          console.log(\\\"\\nðŸ“ˆ TOTAL MESSAGES PROCESSED: \\\" + logs.length);
          "
        else
          echo "â³ No messages yet. Bot is waiting..."
        fi

    - name: ðŸ“Š Generate Report
      run: |
        echo "## ðŸŽ€ Marina Khan AI Bot - Live Report" >> $GITHUB_STEP_SUMMARY
        echo "### â° Generated at: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Activity Summary" >> $GITHUB_STEP_SUMMARY
        if [ -f "message-logs.json" ]; then
          node -e "
          const logs = require('./message-logs.json');
          const received = logs.filter(l => l.type === 'received').length;
          const sent = logs.filter(l => l.type === 'sent').length;
          const seen = logs.filter(l => l.status === 'seen').length;
          const replied = logs.filter(l => l.status === 'replied').length;
          
          console.log(\\\"- ðŸ“© Messages Received: \\\" + received + \\\"\\\");
          console.log(\\\"- ðŸ’Œ Messages Sent: \\\" + sent + \\\"\\\");
          console.log(\\\"- ðŸ‘€ Messages Seen: \\\" + seen + \\\"\\\");
          console.log(\\\"- ðŸ¤– Messages Replied: \\\" + replied + \\\"\\\");
          console.log(\\\"- ðŸ“Š Total Activity: \\\" + logs.length + \\\" events\\\");
          " >> $GITHUB_STEP_SUMMARY
        else
          echo "- â³ No activity yet" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Recent Activity" >> $GITHUB_STEP_SUMMARY
        if [ -f "message-logs.json" ]; then
          node -e "
          const logs = require('./message-logs.json');
          const recent = logs.slice(-5);
          recent.forEach(log => {
            const time = new Date(log.timestamp).toLocaleTimeString();
            const status = log.status === 'seen' ? 'ðŸ‘€' : log.status === 'replied' ? 'ðŸ¤–' : 'â³';
            console.log(\\\"- \\\" + status + \\\" [\\\" + time + \\\"] \\\" + log.user + \\\": \\\" + log.message + \\\"\\\");
          });
          " >> $GITHUB_STEP_SUMMARY
        fi

    - name: âœ… Success
      run: |
        echo "ðŸŽ‰ MARINA BOT LIVE MONITOR COMPLETED!"
        echo "ðŸ’– Check the summary above for detailed activity"
